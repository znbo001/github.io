<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒç³»ç»Ÿå®¢æˆ·ç®¡ç† - å®Œæ•´ç‰ˆ</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f8f9fa; 
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            color: #2c3e50;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .system-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .system-tab {
            padding: 12px 24px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .system-tab.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .system-tab:hover:not(.active) {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .form-group { 
            margin: 15px 0; 
        }
        
        input, button, select, textarea, .file-input { 
            width: 100%; 
            padding: 12px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .file-input {
            padding: 10px;
            border: 2px dashed #3498db;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 8px;
        }
        
        button { 
            background: #3498db; 
            color: white; 
            cursor: pointer; 
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        button:hover { 
            background: #2980b9; 
        }
        
        .error { 
            color: #e74c3c; 
            margin: 10px 0; 
            text-align: center;
            padding: 10px;
            background: #fdf2f2;
            border-radius: 8px;
        }
        
        .success { 
            color: #27ae60; 
            margin: 10px 0; 
            text-align: center;
            padding: 10px;
            background: #f2fdf5;
            border-radius: 8px;
        }
        
        .actions { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            margin: 25px 0;
        }
        
        .actions button { 
            flex: 1; 
            min-width: 140px; 
            padding: 12px;
            font-size: 15px;
        }
        
        .customer-card { 
            background: white; 
            margin: 15px 0; 
            padding: 20px; 
            border: 1px solid #e9ecef; 
            border-radius: 10px;
            position: relative;
            transition: box-shadow 0.3s;
        }
        
        .customer-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .customer-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px;
        }
        
        .customer-header h3 {
            font-size: 18px;
            color: #2c3e50;
        }
        
        .tag { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 13px; 
            margin-right: 8px;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 500;
        }
        
        .tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .tag-intent { background: #2ecc71; }
        .tag-invalid { background: #e74c3c; }
        .tag-follow { background: #f39c12; }
        .tag-none { 
            background: #bdc3c7; 
            border: 1px dashed #95a5a6;
            color: #7f8c8d;
        }
        
        .hidden { 
            display: none !important; 
        }
        
        /* æ‚¬æµ®çª—å£ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 580px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            background: none;
            border: none;
            font-size: 26px;
            cursor: pointer;
            color: #666;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: #f8f9fa;
            color: #333;
        }
        
        /* å¯åŠ¨ç•Œé¢ */
        .startup-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .startup-section h2 {
            font-size: 24px;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .startup-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .startup-buttons button {
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .password-section {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .password-section h3 {
            text-align: center;
            margin-bottom: 25px;
            color: #2c3e50;
        }
        
        /* ä¸‹æ‹‰ç­›é€‰åŒºåŸŸ */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        /* å¤šé€‰åˆ é™¤åŒºåŸŸ */
        .selection-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
        }
        
        .selection-actions button {
            flex: 1;
            min-width: auto;
            padding: 8px;
            font-size: 14px;
            background: #ff6b6b;
        }
        
        /* å®¢æˆ·å¡ç‰‡é€‰æ‹©æ¡† */
        .customer-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 2;
        }
        
        .customer-card.selected {
            border-color: #3498db;
            background-color: #e8f4fd;
        }
        
        /* å†å²è®°å½•æ ·å¼ */
        .history-item {
            background: #f8f9fa;
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            font-size: 12px;
            border-left: 3px solid #3498db;
        }
        
        .history-time {
            color: #6c757d;
            font-weight: bold;
        }
        
        .history-tag {
            color: #27ae60;
            font-weight: bold;
        }
        
        .history-note {
            color: #e74c3c;
        }
        
        /* ç³»ç»Ÿåˆ‡æ¢å¯†ç éªŒè¯ */
        .switch-password-modal {
            text-align: center;
        }
        
        .switch-password-modal h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .system-tabs { flex-direction: column; align-items: center; gap: 10px; }
            .actions { flex-direction: column; }
            .actions button { min-width: auto; }
            .filters { grid-template-columns: 1fr; padding: 15px; }
            .modal-content {
                padding: 25px;
                margin: 10px;
            }
            .customer-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .startup-buttons {
                gap: 12px;
            }
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯åŠ¨ç•Œé¢ -->
        <div id="startup-section" class="startup-section">
            <h2>åŒç³»ç»Ÿå®¢æˆ·ç®¡ç†</h2>
            <div class="startup-buttons">
                <button onclick="showNewPasswordForm()">ğŸ†• æ–°å»ºæ•°æ®</button>
                <button onclick="showLoadBackupForm()" style="background: #2ecc71;">ğŸ“‚ åŠ è½½å¤‡ä»½æ•°æ®</button>
                <p style="margin-top: 20px; color: #666; font-size: 14px;">
                    ğŸ’¡ æ”¯æŒä¸šä¸»ç®¡ç†å’Œå®¢æˆ·ç®¡ç†åŒç³»ç»Ÿ
                </p>
            </div>
        </div>

        <!-- è®¾ç½®æ–°å¯†ç ç•Œé¢ -->
        <div id="new-password-section" class="hidden password-section">
            <h3>è®¾ç½®è®¿é—®å¯†ç </h3>
            <div class="form-group">
                <input type="password" id="new-password" placeholder="è¯·è¾“å…¥å¯†ç " required>
            </div>
            <div class="form-group">
                <input type="password" id="new-password-confirm" placeholder="è¯·ç¡®è®¤å¯†ç " required>
            </div>
            <button onclick="createNewData()" style="margin-top: 20px; padding: 12px; font-size: 16px;">åˆ›å»ºæ–°æ•°æ®</button>
            <button onclick="showStartupSection()" style="margin-top: 10px; background: #95a5a6; padding: 12px; font-size: 16px;">è¿”å›</button>
            <div id="new-password-error" class="error" style="margin-top: 15px;"></div>
        </div>

        <!-- åŠ è½½å¤‡ä»½ç•Œé¢ -->
        <div id="load-backup-section" class="hidden password-section">
            <h3>åŠ è½½å¤‡ä»½æ•°æ®</h3>
            <div class="form-group">
                <label for="backup-file" class="file-input" id="backup-file-label">
                    é€‰æ‹©å¤‡ä»½æ–‡ä»¶ï¼ˆ.jsonï¼‰
                </label>
                <input type="file" id="backup-file" accept=".json" style="display: none;" onchange="updateBackupFileLabel()">
            </div>
            <div class="form-group">
                <input type="password" id="backup-password" placeholder="è¯·è¾“å…¥å¤‡ä»½å¯†ç " required>
            </div>
            <button onclick="loadBackupData()" style="margin-top: 20px; padding: 12px; font-size: 16px;">åŠ è½½æ•°æ®</button>
            <button onclick="showStartupSection()" style="margin-top: 10px; background: #95a5a6; padding: 12px; font-size: 16px;">è¿”å›</button>
            <div id="load-backup-error" class="error" style="margin-top: 15px;"></div>
        </div>

        <!-- ä¸»åº”ç”¨ç•Œé¢ -->
        <div id="main-section" class="hidden">
            <!-- ç³»ç»Ÿåˆ‡æ¢æ ‡ç­¾ -->
            <div class="system-tabs">
                <div class="system-tab active" id="owner-tab" onclick="switchToSystem('owner')">
                    ğŸ  ä¸šä¸»ç®¡ç†
                </div>
                <div class="system-tab" id="customer-tab" onclick="switchToSystem('customer')">
                    ğŸ‘¥ å®¢æˆ·ç®¡ç†
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 id="system-title">ä¸šä¸»ç®¡ç†ç³»ç»Ÿ</h2>
                <button onclick="logout()" style="width: auto; padding: 8px 16px; font-size: 14px; background: #e74c3c;">é€€å‡º</button>
            </div>
            
            <div class="actions">
                <button onclick="showImportModal()">å¯¼å…¥Excel</button>
                <button onclick="showAddCustomerForm()">æ·»åŠ å®¢æˆ·</button>
                <button onclick="showBackupModal()">å¤‡ä»½æ•°æ®</button>
                <button onclick="toggleSelectionMode()" id="select-mode-btn" style="background: #f39c12;">é€‰æ‹©æ¨¡å¼</button>
            </div>
            
            <!-- ä¸‹æ‹‰ç­›é€‰åŒºåŸŸ -->
            <div class="filters" id="filters-container">
                <!-- ç­›é€‰å­—æ®µä¼šæ ¹æ®ç³»ç»ŸåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- å¤šé€‰åˆ é™¤åŒºåŸŸ -->
            <div id="selection-actions" class="selection-actions hidden">
                <button onclick="deleteSelectedCustomers()">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­é¡¹ (<span id="selected-count">0</span>)</button>
                <button onclick="cancelSelection()" style="background: #95a5a6;">å–æ¶ˆé€‰æ‹©</button>
            </div>
            
            <div id="customer-list">
                <div class="empty-state">
                    <div>ğŸ“‹</div>
                    <h3>æš‚æ— å®¢æˆ·æ•°æ®</h3>
                    <p>ç‚¹å‡»"å¯¼å…¥Excel"æˆ–"æ·»åŠ å®¢æˆ·"å¼€å§‹ä½¿ç”¨</p>
                </div>
            </div>
        </div>
    </div>
    <!-- å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="import-modal" class="hidden modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeImportModal()">Ã—</button>
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 24px;">å¯¼å…¥å®¢æˆ·æ•°æ®</h3>
            <p style="text-align: center; margin-bottom: 20px; color: #666;" id="import-template-text">æ”¯æŒ .csv æ ¼å¼æ–‡ä»¶ï¼ˆExcelå¯ç›´æ¥æ‰“å¼€ï¼‰</p>
            <button onclick="downloadTemplate()" style="background: #2ecc71; margin: 10px 0; padding: 14px; width: 100%; font-size: 16px; font-weight: 600;" id="download-template-btn">ä¸‹è½½å¯¼å…¥æ¨¡æ¿</button>
            <div class="form-group">
                <label for="excel-file" class="file-input" id="file-label">
                    é€‰æ‹©CSVæ–‡ä»¶ï¼ˆç‚¹å‡»æˆ–æ‹–æ‹½ï¼‰
                </label>
                <input type="file" id="excel-file" accept=".csv,.txt" style="display: none;" onchange="updateFileLabel()">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="importExcel()" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600;">å¯¼å…¥</button>
                <button onclick="closeImportModal()" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px; font-weight: 600;">å–æ¶ˆ</button>
            </div>
            <div id="import-result" style="margin-top: 20px; min-height: 25px; text-align: center;"></div>
            <div style="margin-top: 20px; font-size: 13px; color: #666; text-align: center; line-height: 1.5;">
                <p><strong>ğŸ’¡ Excelä¿å­˜æ­£ç¡®æ­¥éª¤ï¼š</strong></p>
                <p>1. æ–‡ä»¶ â†’ å¦å­˜ä¸º</p>
                <p>2. ä¿å­˜ç±»å‹é€‰æ‹©ï¼š<strong>CSV UTF-8 (é€—å·åˆ†éš”)(*.csv)</strong></p>
                <p>3. ç‚¹å‡»ä¿å­˜ï¼Œå¦‚æœ‰è­¦å‘Šç‚¹"æ˜¯"</p>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å®¢æˆ·æ¨¡æ€æ¡† -->
    <div id="add-customer-modal" class="hidden modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAddCustomerModal()">Ã—</button>
            <h3 id="modal-title" style="margin-bottom: 25px; text-align: center; font-size: 24px;">æ·»åŠ å®¢æˆ·</h3>
            <div id="customer-form-fields">
                <!-- è¡¨å•å­—æ®µä¼šæ ¹æ®ç³»ç»ŸåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="saveCustomer()" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600;">ä¿å­˜</button>
                <button onclick="closeAddCustomerModal()" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px; font-weight: 600;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¤‡ä»½æ¨¡æ€æ¡† -->
    <div id="backup-modal" class="hidden modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeBackupModal()">Ã—</button>
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 24px;">å¤‡ä»½å®¢æˆ·æ•°æ®</h3>
            <div class="form-group">
                <input type="text" id="backup-filename" placeholder="è¾“å…¥å¤‡ä»½æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰" value="å®¢æˆ·æ•°æ®å¤‡ä»½">
            </div>
            <div class="form-group">
                <input type="password" id="backup-modal-password" placeholder="è¾“å…¥å¤‡ä»½å¯†ç " required>
            </div>
            <div class="form-group">
                <input type="password" id="backup-modal-password-confirm" placeholder="ç¡®è®¤å¤‡ä»½å¯†ç " required>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="createBackup()" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600; background: #2ecc71;">åˆ›å»ºå¤‡ä»½</button>
                <button onclick="closeBackupModal()" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px; font-weight: 600;">å–æ¶ˆ</button>
            </div>
            <div id="backup-result" style="margin-top: 20px; min-height: 25px; text-align: center;"></div>
        </div>
    </div>

    <!-- ç³»ç»Ÿåˆ‡æ¢å¯†ç éªŒè¯æ¨¡æ€æ¡† -->
    <div id="switch-password-modal" class="hidden modal-overlay">
        <div class="modal-content switch-password-modal">
            <button class="close-btn" onclick="closeSwitchPasswordModal()">Ã—</button>
            <h3>éªŒè¯å¯†ç ä»¥åˆ‡æ¢ç³»ç»Ÿ</h3>
            <div class="form-group">
                <input type="password" id="switch-password" placeholder="è¯·è¾“å…¥å½“å‰ç³»ç»Ÿå¯†ç " required>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="confirmSwitchSystem()" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600; background: #3498db;">ç¡®è®¤åˆ‡æ¢</button>
                <button onclick="closeSwitchPasswordModal()" style="flex: 1; background: #95a5a6; padding: 14px; font-size: 16px; font-weight: 600;">å–æ¶ˆ</button>
            </div>
            <div id="switch-password-error" class="error" style="margin-top: 15px;"></div>
        </div>
    </div>
    <script>
        // ========== å…¨å±€é…ç½® ==========
        const APP_KEY = 'dual_system_crm_complete_v1';
        const PREDEFINED_TAGS = ['æœ‰æ„å‘', 'æ— æ•ˆ', 'å†è·Ÿè¿›'];
        const SYSTEMS = {
            owner: {
                name: 'ä¸šä¸»ç®¡ç†',
                fields: ['name', 'community', 'building', 'unit', 'room_number', 'phone', 'tag', 'notes'],
                required: ['community', 'building', 'phone'],
                templateHeaders: ['å§“å', 'å°åŒº', 'æ¥¼æ ‹', 'å•å…ƒ', 'æˆ¿å·', 'æ‰‹æœºå·', 'æ ‡ç­¾', 'å¤‡æ³¨']
            },
            customer: {
                name: 'å®¢æˆ·ç®¡ç†',
                fields: ['name', 'phone', 'wechat', 'tag', 'notes'],
                required: ['name', 'phone'],
                templateHeaders: ['å§“å', 'æ‰‹æœºå·', 'å¾®ä¿¡å·', 'æ ‡ç­¾', 'å¤‡æ³¨']
            }
        };
        
        // ========== åŠ å¯†å·¥å…· ==========
        class CryptoUtils {
            static async generateSalt() {
                return window.crypto.getRandomValues(new Uint8Array(32));
            }
            
            static async deriveKey(password, salt) {
                const encoder = new TextEncoder();
                const passwordBuffer = encoder.encode(password);
                
                const keyMaterial = await window.crypto.subtle.importKey(
                    'raw',
                    passwordBuffer,
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                return await window.crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                );
            }
            
            static async encryptData(data, password) {
                const salt = await this.generateSalt();
                const key = await this.deriveKey(password, salt);
                
                const encoder = new TextEncoder();
                const dataBuffer = encoder.encode(JSON.stringify(data));
                
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encryptedBuffer = await window.crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    dataBuffer
                );
                
                return {
                    salt: Array.from(salt),
                    iv: Array.from(iv),
                    encryptedData: Array.from(new Uint8Array(encryptedBuffer)),
                    createdAt: new Date().toISOString()
                };
            }
            
            static async decryptData(encryptedObj, password) {
                const { salt, iv, encryptedData } = encryptedObj;
                const key = await this.deriveKey(password, new Uint8Array(salt));
                
                const decryptedBuffer = await window.crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: new Uint8Array(iv) },
                    key,
                    new Uint8Array(encryptedData)
                );
                
                const decoder = new TextDecoder();
                const jsonString = decoder.decode(decryptedBuffer);
                return JSON.parse(jsonString);
            }
        }
        
        // ========== æ•°æ®ç®¡ç† ==========
        function saveCurrentData(system, customers) {
            const allData = JSON.parse(localStorage.getItem(APP_KEY) || '{}');
            allData[system] = customers;
            localStorage.setItem(APP_KEY, JSON.stringify(allData));
        }
        
        function loadCurrentData(system) {
            const allData = JSON.parse(localStorage.getItem(APP_KEY) || '{}');
            return allData[system] || [];
        }
        
        function loadAllData() {
            return JSON.parse(localStorage.getItem(APP_KEY) || '{}');
        }
        
        // ========== ç•Œé¢æ§åˆ¶ ==========
        function showStartupSection() {
            document.getElementById('startup-section').classList.remove('hidden');
            document.getElementById('new-password-section').classList.add('hidden');
            document.getElementById('load-backup-section').classList.add('hidden');
            document.getElementById('main-section').classList.add('hidden');
            clearErrors();
        }
        
        function showNewPasswordForm() {
            document.getElementById('startup-section').classList.add('hidden');
            document.getElementById('new-password-section').classList.remove('hidden');
            document.getElementById('load-backup-section').classList.add('hidden');
            document.getElementById('main-section').classList.add('hidden');
            clearErrors();
        }
        
        function showLoadBackupForm() {
            document.getElementById('startup-section').classList.add('hidden');
            document.getElementById('new-password-section').classList.add('hidden');
            document.getElementById('load-backup-section').classList.remove('hidden');
            document.getElementById('main-section').classList.add('hidden');
            clearErrors();
        }
        
        function showMainSection(currentSystem = 'owner') {
            document.getElementById('startup-section').classList.add('hidden');
            document.getElementById('new-password-section').classList.add('hidden');
            document.getElementById('load-backup-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            
            window.currentSystem = currentSystem;
            window.customers = loadCurrentData(currentSystem);
            window.filteredCustomers = [...window.customers];
            window.selectionMode = false;
            window.selectedCustomers = new Set();
            
            updateSystemUI();
            renderCustomerList(window.filteredCustomers);
            updateFilterDropdowns();
            updateSelectionUI();
        }
        
        function updateSystemUI() {
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.getElementById('owner-tab').classList.toggle('active', window.currentSystem === 'owner');
            document.getElementById('customer-tab').classList.toggle('active', window.currentSystem === 'customer');
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('system-title').textContent = SYSTEMS[window.currentSystem].name;
            
            // æ›´æ–°ç­›é€‰åŒºåŸŸ
            updateFiltersUI();
        }
        
        function updateFiltersUI() {
            const filtersContainer = document.getElementById('filters-container');
            const systemConfig = SYSTEMS[window.currentSystem];
            
            let filtersHTML = '';
            
            // å§“åç­›é€‰
            if (systemConfig.fields.includes('name')) {
                filtersHTML += `
                    <div class="filter-group">
                        <label class="filter-label">å§“å</label>
                        <input type="text" id="filter-name" placeholder="æœç´¢å§“å..." oninput="applyFilters()">
                    </div>
                `;
            }
            
            // ä¸šä¸»ç®¡ç†ç‰¹æœ‰å­—æ®µ
            if (window.currentSystem === 'owner') {
                filtersHTML += `
                    <div class="filter-group">
                        <label class="filter-label">å°åŒº</label>
                        <select id="filter-community" onchange="onCommunityChange()">
                            <option value="">æ‰€æœ‰å°åŒº</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">æ¥¼æ ‹</label>
                        <select id="filter-building" onchange="onBuildingChange()">
                            <option value="">æ‰€æœ‰æ¥¼æ ‹</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">å•å…ƒ</label>
                        <select id="filter-unit" onchange="onUnitChange()">
                            <option value="">æ‰€æœ‰å•å…ƒ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">æˆ¿å·</label>
                        <select id="filter-room" onchange="applyFilters()">
                            <option value="">æ‰€æœ‰æˆ¿å·</option>
                        </select>
                    </div>
                `;
            }
            
            // æ‰‹æœºå·ç­›é€‰ï¼ˆä¸¤ä¸ªç³»ç»Ÿéƒ½æœ‰ï¼‰
            filtersHTML += `
                <div class="filter-group">
                    <label class="filter-label">æ‰‹æœºå·</label>
                    <input type="text" id="filter-phone" placeholder="æœç´¢æ‰‹æœºå·..." oninput="applyFilters()">
                </div>
            `;
            
            // å¾®ä¿¡å·ç­›é€‰ï¼ˆå®¢æˆ·ç®¡ç†ç‰¹æœ‰ï¼‰
            if (window.currentSystem === 'customer') {
                filtersHTML += `
                    <div class="filter-group">
                        <label class="filter-label">å¾®ä¿¡å·</label>
                        <input type="text" id="filter-wechat" placeholder="æœç´¢å¾®ä¿¡å·..." oninput="applyFilters()">
                    </div>
                `;
            }
            
            // æ ‡ç­¾ç­›é€‰
            filtersHTML += `
                <div class="filter-group">
                    <label class="filter-label">æ ‡ç­¾</label>
                    <select id="filter-tag" onchange="applyFilters()">
                        <option value="">æ‰€æœ‰æ ‡ç­¾</option>
                        <option value="æœ‰æ„å‘">æœ‰æ„å‘</option>
                        <option value="æ— æ•ˆ">æ— æ•ˆ</option>
                        <option value="å†è·Ÿè¿›">å†è·Ÿè¿›</option>
                    </select>
                </div>
            `;
            
            // æ“ä½œæŒ‰é’®
            filtersHTML += `
                <div class="filter-group">
                    <label class="filter-label">æ“ä½œ</label>
                    <button onclick="clearAllFilters()" style="background: #95a5a6; padding: 8px; font-size: 14px;">æ¸…ç©ºç­›é€‰</button>
                </div>
            `;
            
            filtersContainer.innerHTML = filtersHTML;
        }
        
        function updateCustomerFormUI() {
            const formFields = document.getElementById('customer-form-fields');
            const systemConfig = SYSTEMS[window.currentSystem];
            
            let formHTML = '';
            
            // å§“åå­—æ®µ
            if (systemConfig.fields.includes('name')) {
                formHTML += `<div class="form-group"><input type="text" id="name" placeholder="å§“å*" required></div>`;
            }
            
            // ä¸šä¸»ç®¡ç†å­—æ®µ
            if (window.currentSystem === 'owner') {
                formHTML += `
                    <div class="form-group"><input type="text" id="community" placeholder="å°åŒº*" required></div>
                    <div class="form-group"><input type="text" id="building" placeholder="æ¥¼æ ‹*" required></div>
                    <div class="form-group"><input type="text" id="unit" placeholder="å•å…ƒï¼ˆå¯é€‰ï¼‰"></div>
                    <div class="form-group"><input type="text" id="room_number" placeholder="æˆ¿å·ï¼ˆå¯é€‰ï¼‰"></div>
                `;
            }
            
            // æ‰‹æœºå·å­—æ®µ
            formHTML += `<div class="form-group"><input type="tel" id="phone" placeholder="æ‰‹æœºå·*" required></div>`;
            
            // å¾®ä¿¡å·å­—æ®µ
            if (window.currentSystem === 'customer') {
                formHTML += `<div class="form-group"><input type="text" id="wechat" placeholder="å¾®ä¿¡å·ï¼ˆå¯é€‰ï¼‰"></div>`;
            }
            
            // æ ‡ç­¾å’Œå¤‡æ³¨
            formHTML += `
                <div class="form-group">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #495057;">é€‰æ‹©æ ‡ç­¾ï¼š</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button class="tag-toggle-btn" data-tag="æœ‰æ„å‘" onclick="toggleTagButton(this, 'æœ‰æ„å‘')">æœ‰æ„å‘</button>
                        <button class="tag-toggle-btn" data-tag="æ— æ•ˆ" onclick="toggleTagButton(this, 'æ— æ•ˆ')">æ— æ•ˆ</button>
                        <button class="tag-toggle-btn" data-tag="å†è·Ÿè¿›" onclick="toggleTagButton(this, 'å†è·Ÿè¿›')">å†è·Ÿè¿›</button>
                    </div>
                </div>
                <div class="form-group">
                    <textarea id="notes" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" rows="3"></textarea>
                </div>
            `;
            
            formFields.innerHTML = formHTML;
        }
        
        function logout() {
            showStartupSection();
        }
        
        function clearErrors() {
            document.getElementById('new-password-error').textContent = '';
            document.getElementById('load-backup-error').textContent = '';
            document.getElementById('switch-password-error').textContent = '';
        }
        
        function showError(section, message) {
            document.getElementById(`${section}-error`).textContent = message;
        }
        
        function showSuccess(section, message) {
            const errorDiv = document.getElementById(`${section}-error`);
            errorDiv.textContent = message;
            errorDiv.className = 'success';
            setTimeout(() => {
                errorDiv.textContent = '';
                errorDiv.className = 'error';
            }, 3000);
        }
        
        // ========== ç³»ç»Ÿåˆ‡æ¢ ==========
        function switchToSystem(targetSystem) {
            if (window.currentSystem === targetSystem) return;
            
            // æ˜¾ç¤ºå¯†ç éªŒè¯æ¨¡æ€æ¡†
            window.targetSystem = targetSystem;
            document.getElementById('switch-password-modal').classList.remove('hidden');
            document.getElementById('switch-password').value = '';
            document.getElementById('switch-password-error').textContent = '';
        }
        
        function closeSwitchPasswordModal() {
            document.getElementById('switch-password-modal').classList.add('hidden');
        }
        
        async function confirmSwitchSystem() {
            const password = document.getElementById('switch-password').value;
            if (!password) {
                showError('switch-password', 'è¯·è¾“å…¥å¯†ç ');
                return;
            }
            
            try {
                // éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®
                const allData = loadAllData();
                if (Object.keys(allData).length > 0) {
                    // å¦‚æœæœ‰æ•°æ®ï¼Œç›´æ¥åˆ‡æ¢ï¼ˆå¯†ç å·²åœ¨åŠ è½½æ—¶éªŒè¯ï¼‰
                    showMainSection(window.targetSystem);
                    closeSwitchPasswordModal();
                } else {
                    // æ²¡æœ‰æ•°æ®ï¼Œç›´æ¥åˆ‡æ¢
                    showMainSection(window.targetSystem);
                    closeSwitchPasswordModal();
                }
            } catch (error) {
                showError('switch-password', 'å¯†ç é”™è¯¯');
            }
        }
        
        // ========== æ–°å»ºæ•°æ® ==========
        async function createNewData() {
            const password = document.getElementById('new-password').value;
            const confirm = document.getElementById('new-password-confirm').value;
            
            if (!password) {
                showError('new-password', 'è¯·è¾“å…¥å¯†ç ');
                return;
            }
            
            if (password !== confirm) {
                showError('new-password', 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            // åˆ›å»ºç©ºæ•°æ®
            localStorage.setItem(APP_KEY, JSON.stringify({
                owner: [],
                customer: []
            }));
            showMainSection('owner');
        }
        
        // ========== åŠ è½½å¤‡ä»½ ==========
        async function loadBackupData() {
            const fileInput = document.getElementById('backup-file');
            const password = document.getElementById('backup-password').value;
            
            if (!fileInput.files[0]) {
                showError('load-backup', 'è¯·é€‰æ‹©å¤‡ä»½æ–‡ä»¶');
                return;
            }
            
            if (!password) {
                showError('load-backup', 'è¯·è¾“å…¥å¤‡ä»½å¯†ç ');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    const allData = await CryptoUtils.decryptData(backupData, password);
                    localStorage.setItem(APP_KEY, JSON.stringify(allData));
                    showMainSection('owner');
                } catch (error) {
                    showError('load-backup', 'å¯†ç é”™è¯¯æˆ–æ–‡ä»¶æŸå');
                }
            };
            
            reader.onerror = function() {
                showError('load-backup', 'æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            
            reader.readAsText(file);
        }
        
        function updateBackupFileLabel() {
            const fileInput = document.getElementById('backup-file');
            const label = document.getElementById('backup-file-label');
            if (fileInput.files.length > 0) {
                label.textContent = fileInput.files[0].name;
            } else {
                label.textContent = 'é€‰æ‹©å¤‡ä»½æ–‡ä»¶ï¼ˆ.jsonï¼‰';
            }
        }
        
        // ========== å¤‡ä»½åŠŸèƒ½ ==========
        function showBackupModal() {
            document.getElementById('backup-modal').classList.remove('hidden');
            document.getElementById('backup-filename').value = `${SYSTEMS[window.currentSystem].name}_å¤‡ä»½_${new Date().toISOString().slice(0,10)}`;
            document.getElementById('backup-modal-password').value = '';
            document.getElementById('backup-modal-password-confirm').value = '';
            document.getElementById('backup-result').innerHTML = '';
        }
        
        function closeBackupModal() {
            document.getElementById('backup-modal').classList.add('hidden');
        }
        
        async function createBackup() {
            const filename = document.getElementById('backup-filename').value;
            const password = document.getElementById('backup-modal-password').value;
            const confirm = document.getElementById('backup-modal-password-confirm').value;
            
            if (!filename) {
                document.getElementById('backup-result').innerHTML = '<div class="error">è¯·è¾“å…¥å¤‡ä»½æ–‡ä»¶å</div>';
                return;
            }
            
            if (!password) {
                document.getElementById('backup-result').innerHTML = '<div class="error">è¯·è¾“å…¥å¤‡ä»½å¯†ç </div>';
                return;
            }
            
            if (password !== confirm) {
                document.getElementById('backup-result').innerHTML = '<div class="error">ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´</div>';
                return;
            }
            
            try {
                const allData = loadAllData();
                const encryptedData = await CryptoUtils.encryptData(allData, password);
                const dataStr = JSON.stringify(encryptedData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${filename}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                document.getElementById('backup-result').innerHTML = '<div class="success">å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½ï¼</div>';
                setTimeout(() => closeBackupModal(), 2000);
            } catch (error) {
                document.getElementById('backup-result').innerHTML = `<div class="error">å¤‡ä»½å¤±è´¥: ${error.message}</div>`;
            }
        }
        // ========== å®¢æˆ·ç®¡ç† ==========
        function showAddCustomerForm() {
            document.getElementById('modal-title').textContent = `æ·»åŠ ${SYSTEMS[window.currentSystem].name.slice(0, -2)}`;
            updateCustomerFormUI();
            clearCustomerForm();
            document.getElementById('add-customer-modal').classList.remove('hidden');
            window.currentEditId = null;
        }
        
        function editCustomer(customerId) {
            // å¦‚æœåœ¨é€‰æ‹©æ¨¡å¼ä¸‹ï¼Œä¸è¿›è¡Œç¼–è¾‘
            if (window.selectionMode) {
                toggleCustomerSelection(customerId);
                return;
            }
            
            const customer = window.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            document.getElementById('modal-title').textContent = `ç¼–è¾‘${SYSTEMS[window.currentSystem].name.slice(0, -2)}`;
            updateCustomerFormUI();
            
            // è®¾ç½®å­—æ®µå€¼
            if (customer.name) document.getElementById('name').value = customer.name;
            if (window.currentSystem === 'owner') {
                if (customer.community) document.getElementById('community').value = customer.community;
                if (customer.building) document.getElementById('building').value = customer.building;
                if (customer.unit) document.getElementById('unit').value = customer.unit;
                if (customer.room_number) document.getElementById('room_number').value = customer.room_number;
            }
            if (customer.phone) document.getElementById('phone').value = customer.phone;
            if (window.currentSystem === 'customer' && customer.wechat) {
                document.getElementById('wechat').value = customer.wechat;
            }
            if (customer.notes) document.getElementById('notes').value = customer.notes;
            
            // è®¾ç½®æ ‡ç­¾
            const tagButtons = document.querySelectorAll('.tag-toggle-btn');
            tagButtons.forEach(btn => {
                if (btn.dataset.tag === customer.tag) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            window.currentEditId = customerId;
            document.getElementById('add-customer-modal').classList.remove('hidden');
        }
        
        function toggleTagButton(button, tag) {
            const allButtons = document.querySelectorAll('.tag-toggle-btn');
            allButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            window.selectedTag = tag;
        }
        
        function saveCustomer() {
            const customerData = {
                id: window.currentEditId || Date.now().toString(),
                name: document.getElementById('name')?.value || '',
                phone: document.getElementById('phone')?.value || '',
                tag: window.selectedTag || '',
                notes: document.getElementById('notes')?.value || '',
                createdAt: window.currentEditId ? 
                    window.customers.find(c => c.id === window.currentEditId)?.createdAt : 
                    new Date().toISOString(),
                tagHistory: window.currentEditId ? 
                    window.customers.find(c => c.id === window.currentEditId)?.tagHistory || [] : 
                    [],
                notesHistory: window.currentEditId ? 
                    window.customers.find(c => c.id === window.currentEditId)?.notesHistory || [] : 
                    []
            };
            
            // ç³»ç»Ÿç‰¹å®šå­—æ®µ
            if (window.currentSystem === 'owner') {
                customerData.community = document.getElementById('community')?.value || '';
                customerData.building = document.getElementById('building')?.value || '';
                customerData.unit = document.getElementById('unit')?.value || '';
                customerData.room_number = document.getElementById('room_number')?.value || '';
            } else {
                customerData.wechat = document.getElementById('wechat')?.value || '';
            }
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const requiredFields = SYSTEMS[window.currentSystem].required;
            for (const field of requiredFields) {
                if (!customerData[field]) {
                    alert(`${getFriendlyFieldName(field)}ä¸ºå¿…å¡«é¡¹`);
                    return;
                }
            }
            
            // è®°å½•æ ‡ç­¾å˜æ›´å†å²
            if (window.currentEditId) {
                const originalCustomer = window.customers.find(c => c.id === window.currentEditId);
                if (originalCustomer && originalCustomer.tag !== customerData.tag) {
                    customerData.tagHistory.push({
                        oldTag: originalCustomer.tag,
                        newTag: customerData.tag,
                        timestamp: new Date().toISOString()
                    });
                }
            } else {
                // æ–°å®¢æˆ·ï¼Œè®°å½•åˆå§‹æ ‡ç­¾
                if (customerData.tag) {
                    customerData.tagHistory.push({
                        oldTag: '',
                        newTag: customerData.tag,
                        timestamp: customerData.createdAt
                    });
                }
            }
            
            // è®°å½•å¤‡æ³¨å†å²
            if (customerData.notes) {
                customerData.notesHistory.push({
                    note: customerData.notes,
                    timestamp: new Date().toISOString()
                });
            }
            
            if (window.currentEditId) {
                const index = window.customers.findIndex(c => c.id === window.currentEditId);
                if (index !== -1) {
                    window.customers[index] = customerData;
                }
            } else {
                window.customers.push(customerData);
            }
            
            saveCurrentData(window.currentSystem, window.customers);
            applyFilters();
            closeAddCustomerModal();
            window.selectedTag = '';
        }
        
        function getFriendlyFieldName(field) {
            const fieldMap = {
                'name': 'å§“å',
                'community': 'å°åŒº',
                'building': 'æ¥¼æ ‹',
                'phone': 'æ‰‹æœºå·',
                'wechat': 'å¾®ä¿¡å·'
            };
            return fieldMap[field] || field;
        }
        
        function closeAddCustomerModal() {
            document.getElementById('add-customer-modal').classList.add('hidden');
            window.currentEditId = null;
            window.selectedTag = '';
            const tagButtons = document.querySelectorAll('.tag-toggle-btn');
            tagButtons.forEach(btn => btn.classList.remove('active'));
        }
        
        function clearCustomerForm() {
            const fields = ['name', 'community', 'building', 'unit', 'room_number', 'phone', 'wechat', 'notes'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
            window.selectedTag = '';
        }
        
        // ========== å¤šé€‰åˆ é™¤åŠŸèƒ½ ==========
        function toggleSelectionMode() {
            window.selectionMode = !window.selectionMode;
            const btn = document.getElementById('select-mode-btn');
            
            if (window.selectionMode) {
                btn.textContent = 'å®Œæˆé€‰æ‹©';
                btn.style.background = '#27ae60';
                document.getElementById('selection-actions').classList.remove('hidden');
            } else {
                btn.textContent = 'é€‰æ‹©æ¨¡å¼';
                btn.style.background = '#f39c12';
                document.getElementById('selection-actions').classList.add('hidden');
                cancelSelection();
            }
            
            renderCustomerList(window.filteredCustomers);
        }
        
        function toggleCustomerSelection(customerId) {
            if (window.selectedCustomers.has(customerId)) {
                window.selectedCustomers.delete(customerId);
            } else {
                window.selectedCustomers.add(customerId);
            }
            updateSelectionUI();
        }
        
        function updateSelectionUI() {
            document.getElementById('selected-count').textContent = window.selectedCustomers.size;
        }
        
        function deleteSelectedCustomers() {
            if (window.selectedCustomers.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å®¢æˆ·');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${window.selectedCustomers.size} æ¡å®¢æˆ·è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                window.customers = window.customers.filter(customer => 
                    !window.selectedCustomers.has(customer.id)
                );
                
                saveCurrentData(window.currentSystem, window.customers);
                applyFilters();
                cancelSelection();
                alert('åˆ é™¤æˆåŠŸï¼');
            }
        }
        
        function cancelSelection() {
            window.selectedCustomers.clear();
            window.selectionMode = false;
            updateSelectionUI();
            document.getElementById('select-mode-btn').textContent = 'é€‰æ‹©æ¨¡å¼';
            document.getElementById('select-mode-btn').style.background = '#f39c12';
            renderCustomerList(window.filteredCustomers);
        }
        
        // ========== ä¸‹æ‹‰ç­›é€‰åŠŸèƒ½ï¼ˆä¸šä¸»ç®¡ç†ä¸“ç”¨ï¼‰ ==========
        function updateFilterDropdowns() {
            if (window.currentSystem !== 'owner') return;
            
            updateCommunityDropdown();
            updateBuildingDropdown();
            updateUnitDropdown();
            updateRoomDropdown();
        }
        
        function updateCommunityDropdown() {
            const communities = [...new Set(window.customers.map(c => c.community).filter(c => c))];
            const select = document.getElementById('filter-community');
            const currentSelection = select.value;
            
            select.innerHTML = '<option value="">æ‰€æœ‰å°åŒº</option>';
            communities.sort().forEach(community => {
                const option = document.createElement('option');
                option.value = community;
                option.textContent = community;
                if (community === currentSelection) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        function updateBuildingDropdown() {
            const community = document.getElementById('filter-community')?.value || '';
            let buildings = [];
            
            if (community) {
                buildings = [...new Set(
                    window.customers
                        .filter(c => c.community === community)
                        .map(c => c.building)
                        .filter(b => b)
                )];
            } else {
                buildings = [...new Set(window.customers.map(c => c.building).filter(b => b))];
            }
            
            const select = document.getElementById('filter-building');
            const currentSelection = select.value;
            
            if (select) {
                select.innerHTML = '<option value="">æ‰€æœ‰æ¥¼æ ‹</option>';
                buildings.sort().forEach(building => {
                    const option = document.createElement('option');
                    option.value = building;
                    option.textContent = building;
                    if (building === currentSelection) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        }
        
        function updateUnitDropdown() {
            const community = document.getElementById('filter-community')?.value || '';
            const building = document.getElementById('filter-building')?.value || '';
            let units = [];
            
            if (community && building) {
                units = [...new Set(
                    window.customers
                        .filter(c => c.community === community && c.building === building)
                        .map(c => c.unit)
                        .filter(u => u)
                )];
            } else if (building) {
                units = [...new Set(
                    window.customers
                        .filter(c => c.building === building)
                        .map(c => c.unit)
                        .filter(u => u)
                )];
            } else {
                units = [...new Set(window.customers.map(c => c.unit).filter(u => u))];
            }
            
            const select = document.getElementById('filter-unit');
            const currentSelection = select.value;
            
            if (select) {
                select.innerHTML = '<option value="">æ‰€æœ‰å•å…ƒ</option>';
                units.sort().forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    if (unit === currentSelection) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        }
        
        function updateRoomDropdown() {
            const community = document.getElementById('filter-community')?.value || '';
            const building = document.getElementById('filter-building')?.value || '';
            const unit = document.getElementById('filter-unit')?.value || '';
            let rooms = [];
            
            if (community && building && unit) {
                rooms = [...new Set(
                    window.customers
                        .filter(c => c.community === community && c.building === building && c.unit === unit)
                        .map(c => c.room_number)
                        .filter(r => r)
                )];
            } else if (building && unit) {
                rooms = [...new Set(
                    window.customers
                        .filter(c => c.building === building && c.unit === unit)
                        .map(c => c.room_number)
                        .filter(r => r)
                )];
            } else if (unit) {
                rooms = [...new Set(
                    window.customers
                        .filter(c => c.unit === unit)
                        .map(c => c.room_number)
                        .filter(r => r)
                )];
            } else {
                rooms = [...new Set(window.customers.map(c => c.room_number).filter(r => r))];
            }
            
            const select = document.getElementById('filter-room');
            const currentSelection = select.value;
            
            if (select) {
                select.innerHTML = '<option value="">æ‰€æœ‰æˆ¿å·</option>';
                rooms.sort().forEach(room => {
                    const option = document.createElement('option');
                    option.value = room;
                    option.textContent = room;
                    if (room === currentSelection) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        }
        
        function onCommunityChange() {
            if (document.getElementById('filter-building')) {
                document.getElementById('filter-building').value = '';
            }
            if (document.getElementById('filter-unit')) {
                document.getElementById('filter-unit').value = '';
            }
            if (document.getElementById('filter-room')) {
                document.getElementById('filter-room').value = '';
            }
            updateBuildingDropdown();
            updateUnitDropdown();
            updateRoomDropdown();
            applyFilters();
        }
        
        function onBuildingChange() {
            if (document.getElementById('filter-unit')) {
                document.getElementById('filter-unit').value = '';
            }
            if (document.getElementById('filter-room')) {
                document.getElementById('filter-room').value = '';
            }
            updateUnitDropdown();
            updateRoomDropdown();
            applyFilters();
        }
        
        function onUnitChange() {
            if (document.getElementById('filter-room')) {
                document.getElementById('filter-room').value = '';
            }
            updateRoomDropdown();
            applyFilters();
        }
        
        // ========== ç­›é€‰åŠŸèƒ½ ==========
        function applyFilters() {
            let filtered = window.customers;
            
            // å§“åç­›é€‰
            const nameFilter = document.getElementById('filter-name')?.value.toLowerCase() || '';
            if (nameFilter) {
                filtered = filtered.filter(c => c.name && c.name.toLowerCase().includes(nameFilter));
            }
            
            // ä¸šä¸»ç®¡ç†ç­›é€‰
            if (window.currentSystem === 'owner') {
                const communityFilter = document.getElementById('filter-community')?.value || '';
                const buildingFilter = document.getElementById('filter-building')?.value || '';
                const unitFilter = document.getElementById('filter-unit')?.value || '';
                const roomFilter = document.getElementById('filter-room')?.value || '';
                
                if (communityFilter) {
                    filtered = filtered.filter(c => c.community === communityFilter);
                }
                if (buildingFilter) {
                    filtered = filtered.filter(c => c.building === buildingFilter);
                }
                if (unitFilter) {
                    filtered = filtered.filter(c => c.unit === unitFilter);
                }
                if (roomFilter) {
                    filtered = filtered.filter(c => c.room_number === roomFilter);
                }
            }
            
            // æ‰‹æœºå·ç­›é€‰
            const phoneFilter = document.getElementById('filter-phone')?.value || '';
            if (phoneFilter) {
                filtered = filtered.filter(c => c.phone && c.phone.includes(phoneFilter));
            }
            
            // å¾®ä¿¡å·ç­›é€‰
            const wechatFilter = document.getElementById('filter-wechat')?.value || '';
            if (wechatFilter && window.currentSystem === 'customer') {
                filtered = filtered.filter(c => c.wechat && c.wechat.includes(wechatFilter));
            }
            
            // æ ‡ç­¾ç­›é€‰
            const tagFilter = document.getElementById('filter-tag')?.value || '';
            if (tagFilter) {
                filtered = filtered.filter(c => c.tag === tagFilter);
            }
            
            window.filteredCustomers = filtered;
            renderCustomerList(window.filteredCustomers);
        }
        
        function clearAllFilters() {
            // é‡ç½®æ‰€æœ‰ç­›é€‰å­—æ®µ
            const filterFields = ['filter-name', 'filter-community', 'filter-building', 
                                'filter-unit', 'filter-room', 'filter-phone', 'filter-wechat', 'filter-tag'];
            
            filterFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
            
            updateFilterDropdowns();
            applyFilters();
        }
        
        // ========== æ ‡ç­¾ç‚¹å‡»åˆ‡æ¢åŠŸèƒ½ ==========
        function toggleCustomerTag(customerId) {
            const customer = window.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const tagIndex = PREDEFINED_TAGS.indexOf(customer.tag);
            let newTag = '';
            if (tagIndex === -1) {
                newTag = PREDEFINED_TAGS[0];
            } else if (tagIndex === PREDEFINED_TAGS.length - 1) {
                newTag = '';
            } else {
                newTag = PREDEFINED_TAGS[tagIndex + 1];
            }
            
            // è®°å½•æ ‡ç­¾å†å²
            customer.tagHistory.push({
                oldTag: customer.tag,
                newTag: newTag,
                timestamp: new Date().toISOString()
            });
            
            customer.tag = newTag;
            saveCurrentData(window.currentSystem, window.customers);
            applyFilters();
        }
        
        // ========== æ•°æ®å±•ç¤º ==========
        function renderCustomerList(customers) {
            const list = document.getElementById('customer-list');
            
            if (customers.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ”</div>
                        <h3>æœªæ‰¾åˆ°åŒ¹é…çš„å®¢æˆ·</h3>
                        <p>å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ·»åŠ æ–°å®¢æˆ·</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = customers.map(customer => {
                const displayFields = [];
                
                if (customer.name) displayFields.push(`å§“å: ${customer.name}`);
                if (window.currentSystem === 'owner') {
                    if (customer.community) displayFields.push(`å°åŒº: ${customer.community}`);
                    if (customer.building) displayFields.push(`æ¥¼æ ‹: ${customer.building}`);
                    if (customer.unit || customer.room_number) {
                        const unitPart = customer.unit ? customer.unit : '';
                        const roomPart = customer.room_number ? customer.room_number : '';
                        displayFields.push(`æˆ¿å·: ${unitPart}${roomPart}`);
                    }
                }
                if (customer.phone) displayFields.push(`<strong>ç”µè¯: ${customer.phone}</strong>`);
                if (window.currentSystem === 'customer' && customer.wechat) {
                    displayFields.push(`å¾®ä¿¡å·: ${customer.wechat}`);
                }
                
                // æ˜¾ç¤ºåˆ›å»ºæ—¶é—´
                const createdAt = new Date(customer.createdAt).toLocaleString('zh-CN');
                displayFields.push(`<em>åˆ›å»ºæ—¶é—´: ${createdAt}</em>`);
                
                // æ˜¾ç¤ºå†å²è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰
                let historyHtml = '';
                if (customer.tagHistory && customer.tagHistory.length > 0) {
                    historyHtml += '<div style="margin-top: 10px;"><strong>æ ‡ç­¾å†å²:</strong>';
                    customer.tagHistory.slice(-3).reverse().forEach(record => {
                        const time = new Date(record.timestamp).toLocaleString('zh-CN');
                        historyHtml += `<div class="history-item"><span class="history-time">${time}</span>: ${record.oldTag || 'æ— '} â†’ <span class="history-tag">${record.newTag || 'æ— '}</span></div>`;
                    });
                    historyHtml += '</div>';
                }
                
                if (customer.notesHistory && customer.notesHistory.length > 0) {
                    historyHtml += '<div style="margin-top: 10px;"><strong>å¤‡æ³¨å†å²:</strong>';
                    customer.notesHistory.slice(-3).reverse().forEach(record => {
                        const time = new Date(record.timestamp).toLocaleString('zh-CN');
                        historyHtml += `<div class="history-item"><span class="history-time">${time}</span>: <span class="history-note">${record.note}</span></div>`;
                    });
                    historyHtml += '</div>';
                }
                
                let tagHtml = '';
                if (customer.tag) {
                    const tagClass = customer.tag === 'æœ‰æ„å‘' ? 'tag-intent' : 
                                   customer.tag === 'æ— æ•ˆ' ? 'tag-invalid' : 'tag-follow';
                    tagHtml = `<span class="tag ${tagClass}" onclick="toggleCustomerTag('${customer.id}')">${customer.tag}</span>`;
                } else {
                    tagHtml = `<span class="tag tag-none" onclick="toggleCustomerTag('${customer.id}')">ç‚¹å‡»è®¾ç½®æ ‡ç­¾</span>`;
                }
                
                const isSelected = window.selectedCustomers.has(customer.id);
                const cardClass = `customer-card${isSelected ? ' selected' : ''}`;
                
                return `
                    <div class="${cardClass}" onclick="editCustomer('${customer.id}')">
                        ${window.selectionMode ? `<input type="checkbox" class="customer-checkbox" onclick="event.stopPropagation(); toggleCustomerSelection('${customer.id}')" ${isSelected ? 'checked' : ''}>` : ''}
                        <div class="customer-header">
                            <h3>${customer.name || customer.phone || 'æœªå‘½åå®¢æˆ·'}</h3>
                            <div style="display:flex; gap:8px; align-items: center;">
                                ${customer.phone ? `<a href="tel:${customer.phone}" style="text-decoration:none; color:#3498db; font-size:22px; font-weight: bold;" onclick="event.stopPropagation();">ğŸ“</a>` : ''}
                                ${!window.selectionMode ? `<button onclick="event.stopPropagation(); editCustomer('${customer.id}')" style="background:#3498db; color:white; border:none; border-radius:6px; padding:4px 10px; font-size:13px; font-weight: 500;">ç¼–è¾‘</button>` : ''}
                            </div>
                        </div>
                        <div>
                            ${displayFields.map(field => `<p style="margin: 4px 0; line-height: 1.4;">${field}</p>`).join('')}
                        </div>
                        <div style="margin-top: 12px;">
                            ${tagHtml}
                        </div>
                        ${historyHtml}
                    </div>
                `;
            }).join('');
        }
        
        // ========== CSV å¯¼å…¥ ==========
        function downloadTemplate() {
            const headers = SYSTEMS[window.currentSystem].templateHeaders.join(',');
            const csvContent = `\uFEFF${headers}\n`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${SYSTEMS[window.currentSystem].name}_å¯¼å…¥æ¨¡æ¿.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function showImportModal() {
            // æ›´æ–°æ¨¡æ€æ¡†æ–‡æœ¬
            document.getElementById('import-template-text').textContent = 
                `æ”¯æŒ .csv æ ¼å¼æ–‡ä»¶ï¼ˆ${SYSTEMS[window.currentSystem].name}æ•°æ®ï¼‰`;
            document.getElementById('download-template-btn').textContent = 
                `ä¸‹è½½${SYSTEMS[window.currentSystem].name}æ¨¡æ¿`;
            
            document.getElementById('import-modal').classList.remove('hidden');
            document.getElementById('import-result').innerHTML = '';
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
            document.getElementById('excel-file').value = '';
            document.getElementById('file-label').textContent = 'é€‰æ‹©CSVæ–‡ä»¶ï¼ˆç‚¹å‡»æˆ–æ‹–æ‹½ï¼‰';
        }
        
        function updateFileLabel() {
            const fileInput = document.getElementById('excel-file');
            const label = document.getElementById('file-label');
            if (fileInput.files.length > 0) {
                label.textContent = fileInput.files[0].name;
            } else {
                label.textContent = 'é€‰æ‹©CSVæ–‡ä»¶ï¼ˆç‚¹å‡»æˆ–æ‹–æ‹½ï¼‰';
            }
        }
        
        function importExcel() {
            const fileInput = document.getElementById('excel-file');
            if (!fileInput.files[0]) {
                document.getElementById('import-result').innerHTML = '<div class="error">è¯·é€‰æ‹©æ–‡ä»¶</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    const text = decodeCsvBuffer(arrayBuffer);
                    processCsvContent(text);
                } catch (error) {
                    document.getElementById('import-result').innerHTML = 
                        `<div class="error">æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}</div>`;
                }
            };
            
            reader.onerror = function() {
                document.getElementById('import-result').innerHTML = 
                    '<div class="error">æ–‡ä»¶è¯»å–å¤±è´¥</div>';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function decodeCsvBuffer(arrayBuffer) {
            const uint8Array = new Uint8Array(arrayBuffer);
            if (uint8Array[0] === 0xEF && uint8Array[1] === 0xBB && uint8Array[2] === 0xBF) {
                const decoder = new TextDecoder('utf-8');
                return decoder.decode(arrayBuffer.slice(3));
            }
            
            try {
                const decoder = new TextDecoder('utf-8', { fatal: true });
                return decoder.decode(arrayBuffer);
            } catch (utf8Error) {
                try {
                    const decoder = new TextDecoder('gbk');
                    return decoder.decode(arrayBuffer);
                } catch (gbkError) {
                    try {
                        const decoder = new TextDecoder('gb2312');
                        return decoder.decode(arrayBuffer);
                    } catch (gb2312Error) {
                        const decoder = new TextDecoder('iso-8859-1');
                        return decoder.decode(arrayBuffer);
                    }
                }
            }
        }
        
        function processCsvContent(content) {
            try {
                let cleanedContent = content;
                if (cleanedContent.charCodeAt(0) === 0xFEFF) {
                    cleanedContent = cleanedContent.slice(1);
                }
                cleanedContent = cleanedContent.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                
                const lines = cleanedContent.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    throw new Error('æ–‡ä»¶ä¸ºç©º');
                }
                
                const headers = parseCsvLineRobust(lines[0]);
                const expectedHeaders = SYSTEMS[window.currentSystem].templateHeaders;
                const validHeaderCount = headers.filter(h => expectedHeaders.includes(h.trim())).length;
                if (validHeaderCount === 0) {
                    throw new Error('è¡¨å¤´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨æ ‡å‡†æ¨¡æ¿');
                }
                
                const customers = [];
                const existingPhones = new Set(window.customers.map(c => c.phone));
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCsvLineRobust(lines[i]);
                    const customer = createCustomerFromRow(values, headers);
                    if (customer) {
                        if (customer.phone && existingPhones.has(customer.phone)) {
                            console.warn(`è·³è¿‡é‡å¤æ‰‹æœºå·: ${customer.phone}`);
                            continue;
                        }
                        if (customer.phone) {
                            existingPhones.add(customer.phone);
                        }
                        customers.push(customer);
                    }
                }
                
                if (customers.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å®¢æˆ·æ•°æ®');
                }
                
                window.customers = [...window.customers, ...customers];
                saveCurrentData(window.currentSystem, window.customers);
                applyFilters();
                updateFilterDropdowns();
                
                document.getElementById('import-result').innerHTML = 
                    `<div class="success">æˆåŠŸå¯¼å…¥ ${customers.length} æ¡å®¢æˆ·æ•°æ®</div>`;
                
                setTimeout(() => closeImportModal(), 2000);
                
            } catch (error) {
                document.getElementById('import-result').innerHTML = 
                    `<div class="error">å¯¼å…¥å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function createCustomerFromRow(values, headers) {
            const customer = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                name: '',
                phone: '',
                tag: '',
                notes: '',
                createdAt: new Date().toISOString(),
                tagHistory: [],
                notesHistory: []
            };
            
            // ç³»ç»Ÿç‰¹å®šå­—æ®µ
            if (window.currentSystem === 'owner') {
                customer.community = '';
                customer.building = '';
                customer.unit = '';
                customer.room_number = '';
            } else {
                customer.wechat = '';
            }
            
            for (let i = 0; i < headers.length && i < values.length; i++) {
                const header = headers[i].trim();
                const value = values[i] ? values[i].trim() : '';
                
                switch (header) {
                    case 'å§“å':
                        customer.name = value;
                        break;
                    case 'å°åŒº':
                        customer.community = value;
                        break;
                    case 'æ¥¼æ ‹':
                        customer.building = value;
                        break;
                    case 'å•å…ƒ':
                        customer.unit = value;
                        break;
                    case 'æˆ¿å·':
                        customer.room_number = value;
                        break;
                    case 'æ‰‹æœºå·':
                        customer.phone = value;
                        break;
                    case 'å¾®ä¿¡å·':
                        customer.wechat = value;
                        break;
                    case 'æ ‡ç­¾':
                        if (PREDEFINED_TAGS.includes(value)) {
                            customer.tag = value;
                            customer.tagHistory.push({
                                oldTag: '',
                                newTag: value,
                                timestamp: customer.createdAt
                            });
                        }
                        break;
                    case 'å¤‡æ³¨':
                        customer.notes = value;
                        if (value) {
                            customer.notesHistory.push({
                                note: value,
                                timestamp: customer.createdAt
                            });
                        }
                        break;
                }
            }
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const requiredFields = SYSTEMS[window.currentSystem].required;
            for (const field of requiredFields) {
                if (!customer[field]) {
                    return null;
                }
            }
            
            return customer;
        }
        
        function parseCsvLineRobust(line) {
            const values = [];
            let inQuotes = false;
            let currentValue = '';
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                const nextChar = line[i + 1] || '';
                
                if (char === '"' && !inQuotes) {
                    inQuotes = true;
                } else if (char === '"' && inQuotes && nextChar === '"') {
                    currentValue += '"';
                    i++;
                } else if (char === '"' && inQuotes) {
                    inQuotes = false;
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue);
                    currentValue = '';
                } else {
                    currentValue += char;
                }
                i++;
            }
            
            values.push(currentValue);
            
            return values.map(val => {
                let cleaned = val.trim();
                if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                    cleaned = cleaned.slice(1, -1).replace(/""/g, '"');
                }
                return cleaned;
            });
        }
        
        // ========== åˆå§‹åŒ– ==========
        function init() {
            const allData = loadAllData();
            if (Object.keys(allData).length > 0) {
                showMainSection('owner');
            } else {
                showStartupSection();
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
